(window.LearnosityAmd=window.LearnosityAmd||[]).push([[37],{234:function(t,e,n){"use strict";n(1);var i=n(0),o=n.n(i),a=n(5),s=n.n(a);function _defineProperties(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}var r=["keydown","keyup"],l={arrowDown:"keydown:arrowDown",arrowLeft:"keydown:arrowLeft",arrowRight:"keydown:arrowRight",arrowUp:"keydown:arrowUp",comboShiftArrowDown:"combo:shiftArrowDown",comboShiftArrowLeft:"combo:shiftArrowLeft",comboShiftArrowRight:"combo:shiftArrowRight",comboShiftArrowUp:"combo:shiftArrowUp",enter:"keydown:enter",escape:"keydown:escape",shift:"keydown:shift"},h={arrowDown:40,arrowLeft:37,arrowRight:39,arrowUp:38,enter:13,escape:27,shift:16,space:32,tab:9},u={comboShiftArrowDown:[h.shift,h.arrowDown],comboShiftArrowLeft:[h.shift,h.arrowLeft],comboShiftArrowRight:[h.shift,h.arrowRight],comboShiftArrowUp:[h.shift,h.arrowUp]},c=function getKeyName(t){return o.a.findKey(h,(function(e){return t===e}))},d=function(){function KeyEmitter(t){var e=this;!function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,KeyEmitter),this.$el=t,this._jqNamespace=".lrn_questions_key_emitter_"+o.a.uniqueId(),this._elEvents={},this._keysDown=[],r.forEach((function(t){e._elEvents[t]=t+"."+e._jqNamespace})),o.a.bindAll(this,"_onKeydown","_onKeyup"),this._addListeners()}return _createClass(KeyEmitter,null,[{key:"keyIs",value:function keyIs(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return o.a.isNumber(e.keyCode)&&t===c(e.keyCode)}},{key:"events",get:function get(){return l}},{key:"keys",get:function get(){return h}}]),_createClass(KeyEmitter,[{key:"remove",value:function remove(){var t=this;this.$el&&(o.a.each(this._elEvents,(function(e){return t.$el.off(e)})),this.$el=null)}},{key:"_addListeners",value:function _addListeners(){this.$el.on(this._elEvents.keydown,this._onKeydown),this.$el.on(this._elEvents.keyup,this._onKeyup)}},{key:"_getKeyCombo",value:function _getKeyCombo(){var t=this;return o.a.findKey(u,(function(e){return o.a.isEqual(e,t._keysDown)}))}},{key:"_onKeydown",value:function _onKeydown(t){var e=c(t.keyCode);if(e){this._keysDown.push(t.keyCode);var n=this._getKeyCombo(),i=l[n||e];i&&this.trigger(i,t)}}},{key:"_onKeyup",value:function _onKeyup(t){c(t.keyCode)&&(this._keysDown=o.a.without(this._keysDown,t.keyCode))}}]),KeyEmitter}();o()(d.prototype).assign(s.a.Events),e.a=d},413:function(t,e,n){"use strict";var i=n(0),o=n.n(i),a=n(1),s=n.n(a),r=n(5),l=n.n(r),h=n(414),u=n.n(h),c=n(234),d=n(154);e.a=l.a.View.extend({CONTAINER_CLASS:"lrn-response-modal-container",WRAPPER_CLASS:"lrn-response-modal-content-wrapper",VISIBILITY_CLASS:"lrn-response-modal-is-visible",UI_SELECTORS:{content:".lrn-response-modal-content"},className:"lrn-response-modal",events:{'click [data-action="lrnResponseModalClose"]':"onDismiss",'touchend [data-action="lrnResponseModalClose"]':"onDismiss"},template:u.a,wrapperClass:"",restoreFocus:null,initialize:function initialize(t){this.options=t,this.wrapperClass="".concat(this.WRAPPER_CLASS," ").concat(this.options.extraClasses||""),this.addKeyboardEvents()},addKeyboardEvents:function addKeyboardEvents(){this.keyEmitter=new c.a(s()(document)),this.listenTo(this.keyEmitter,c.a.events.escape,this.onDismiss)},onDismiss:function onDismiss(t){var e=!0,n={preventDefault:function preventDefault(){e=!1}};this.trigger("dismiss",n),e&&this.remove({wasDismissed:!0}),t.preventDefault()},remove:function remove(t){this.disableFocusTrap(),this.options.contentView.remove(t),this.removeMinHeight(),this.removeKeyboardEvents(),l.a.View.prototype.remove.call(this),this.trigger("remove",t)},removeKeyboardEvents:function removeKeyboardEvents(){this.keyEmitter&&(this.stopListening(this.keyEmitter),this.keyEmitter.remove(),this.keyEmitter=null)},removeMinHeight:function removeMinHeight(){this.$el.parent().css("min-height","")},render:function render(){var t=this.template({wrapperClass:this.wrapperClass}),e=this.options.contentView.render().$el;return this.$el.html(t),this.$(this.UI_SELECTORS.content).append(e),this},setMinHeight:function setMinHeight(){var t=this.$(".".concat(this.WRAPPER_CLASS)),e=window.parseInt(t.css("margin-top")),n=t.outerHeight()+2*e;this.$el.parent().css({minHeight:n})},show:function show(){return this.toggleContainerClass(!0),this.toggleVisibility(!0),this.setMinHeight(),this.enableFocusTrap(),this},enableFocusTrap:function enableFocusTrap(){this.restoreFocus=Object(d.a)(this.el)},disableFocusTrap:function disableFocusTrap(){o.a.isFunction(this.restoreFocus)&&(this.restoreFocus(),this.restoreFocus=null)},toggleContainerClass:function toggleContainerClass(t){this.$el.parent().toggleClass(this.CONTAINER_CLASS,t)},toggleVisibility:function toggleVisibility(t){this.$el.toggleClass(this.VISIBILITY_CLASS,t)}})},414:function(module,exports,__webpack_require__){var _=__webpack_require__(0);module.exports=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="'+(null==(__t=wrapperClass)?"":_.escape(__t))+'"><div class="lrn-response-modal-header"><button class="close lrn-response-modal-header-close" data-action="lrnResponseModalClose" type="button"><span>&times;</span></button></div><div class="lrn-response-modal-content"></div></div>';return __p}},541:function(t,e,n){var i,o;i=[n(0)],void 0===(o=function(t){"use strict";return t.mixin({getNested:function(t,e){if(t){var n=e.match(/(.+?)\.(.*)/);return n?this.getNested(t[n[1]],n[2]):t[e]}},exists:function(t){return null!=t}}),t}.apply(e,i))||(t.exports=o)},542:function(t,e,n){var i;void 0===(i=function(){return{tolerance:.01,setTolerance:function(t){this.tolerance=t},intersectLineLine:function(t,e,n,i){var o,a,s=e.y-t.y,r=t.x-e.x,l=s*t.x+r*t.y,h=i.y-n.y,u=n.x-i.x,c=h*n.x+u*n.y,d=s*u-r*h,p=Math.max(t.x,e.x),g=Math.min(t.x,e.x),f=Math.max(t.y,e.y),m=Math.min(t.y,e.y),v=Math.max(n.x,i.x),b=Math.min(n.x,i.x),y=Math.max(n.y,i.y),A=Math.min(n.y,i.y);if(Math.abs(d)<this.tolerance){var w=!1;if(0!==r&&0!==u){var I=l/r,S=c/u;Math.abs(I-S)<this.tolerance&&(w=!0)}else{var E=l/s,R=c/h;Math.abs(E-R)<this.tolerance&&(w=!0)}return!!(w&&(Math.abs(v-g)<this.tolerance||v>g)&&(Math.abs(y-m)<this.tolerance||y>m))}return o=(u*l-r*c)/d,a=(s*c-h*l)/d,(Math.abs(o-g)<this.tolerance||o>g)&&(Math.abs(o-p)<this.tolerance||o<p)&&(Math.abs(a-m)<this.tolerance||a>m)&&(Math.abs(a-f)<this.tolerance||a<f)&&(Math.abs(o-b)<this.tolerance||o>b)&&(Math.abs(o-v)<this.tolerance||o<v)&&(Math.abs(a-A)<this.tolerance||a>A)&&(Math.abs(a-y)<this.tolerance||a<y)},intersectLinePolygon:function(t,e,n){for(var i=n.length,o=0;o<i;o++){var a=n[o],s=n[(o+1)%i];if(this.intersectLineLine(t,e,a,s))return!0}return!1},pointOnLine:function(t,e,n){var i=Math.max(e.x,n.x),o=Math.min(e.x,n.x),a=Math.max(e.y,n.y),s=Math.min(e.y,n.y);if(t.x<o||t.x>i||t.y<s||t.y>a)return!1;var r=n.y-e.y,l=e.x-n.x,h=r*e.x+l*e.y,u=r*t.x+l*t.y;return Math.abs(u-h)<this.tolerance},pointInPolygon:function(t,e){for(var n,i,o,a,s=Number.MIN_VALUE,r=Number.MIN_VALUE,l=Number.MAX_VALUE,h=Number.MAX_VALUE,u=e.length,c=0,d=0;c<u;c++){if((n=e[c]).x==t.x&&n.y==t.y)return!0;if(i=e[(c+1)%u],this.pointOnLine(t,n,i))return!0;s=Math.max(s,n.x),r=Math.max(r,n.y),l=Math.min(l,n.x),h=Math.min(h,n.y)}if(t.x<l||t.x>s||t.y<h||t.y>r)return!1;for(c=0;c<u;c++)if(n=e[c],i=e[(c+1)%u],this.intersectLineLine(t,{x:s+1,y:t.y},n,i)){if(Math.abs(t.y-n.y)<this.tolerance){if(Math.abs(t.y-i.y)<this.tolerance)continue;for(o=e[(c-(a=1))%u];Math.abs(o.y-n.y)<this.tolerance;){var p=(c-++a)%u;p<0&&(p+=u),o=e[p]}if(o.y>n.y&&i.y>n.y||o.y<n.y&&i.y<n.y){d+=2;continue}if(i.y<n.y){d++;continue}}if(t.y==i.y)continue;d++}return d%2==1},angleSmallerThan:function(t,e,n,i,o){var a=(t.y-e.y)/(t.x-e.x),s=(n.y-i.y)/(n.x-i.x),r=Math.abs((a-s)/(1+a*s));return Math.atan(r)<o},pointsCloserThan:function(t,e,n){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))<n}}}.call(e,n,e,t))||(t.exports=i)},543:function(module,exports,__webpack_require__){var _=__webpack_require__(0);module.exports=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<ul class="lrn_toolbar_left lrn_clearfix"><li class="lrn_btn lrn-imageupload-btn-delete lrn_disabled" unselectable="on" title="'+(null==(__t=labels.imageUpload.deleteMode)?"":__t)+'" tabindex="0"><span class="sr-only" unselectable="on">Delete Mode</span></li><li class="lrn_btn lrn-imageupload-btn-add-annotation" unselectable="on" tabindex="0" title="'+(null==(__t=labels.imageUpload.addAnnotation)?"":__t)+'"><span class="sr-only" unselectable="on">Add Annotation</span></li></ul>',shouldShowConfigButton&&(__p+='<ul class="lrn_toolbar_right lrn_clearfix"><li class="lrn_btn lrn-imageupload-btn-rotate" unselectable="on" title="'+(null==(__t=labels.imageUpload.rotateImage)?"":__t)+'" tabindex="0"><span class="sr-only" unselectable="on">Rotate</span></li><li class="lrn_btn lrn-imageupload-btn-config" unselectable="on" title="'+(null==(__t=labels.imageUpload.configureImage)?"":__t)+'" tabindex="0"><span class="sr-only" unselectable="on">Configure Image</span></li></ul>'),__p+="";return __p}},544:function(module,exports,__webpack_require__){var _=__webpack_require__(0);module.exports=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="lrn-imageupload-annotation-bubble"><div class="lrn-imageupload-annotation-drag-handle',isDraggable&&(__p+=" lrn-imageupload-annotation-draggables-with-hover-states lrn-imageupload-annotation-drag-handle-draggable"),__p+='"><div class="lrn-imageupload-annotation-point',isDraggable&&(__p+=" lrn-imageupload-annotation-point-draggable"),__p+='"></div><div class="lrn-imageupload-annotation-arrow"></div></div><div class="lrn-imageupload-annotation-preview',isEditable&&(__p+=" lrn-imageupload-annotation-preview-editable"),__p+='"><div class="lrn-imageupload-annotation-preview-inner" data-lrn-drag-exception><p><span>'+(null==(__t=preview)?"":_.escape(__t))+'</span></p></div></div><div class="lrn-imageupload-annotation-content',isEditable&&(__p+=" lrn-imageupload-annotation-content-editable"),__p+='"><textarea',isEditable||(__p+=" disabled"),__p+=">"+(null==(__t=content)?"":_.escape(__t))+'</textarea><div class="lrn-imageupload-annotation-arrow"></div></div><button class="lrn_btn lrn-imageupload-annotation-btn-delete" type="button" data-lrn-drag-exception><span class="lrn-imageupload-annotation-btn-delete-icon">&times;</span><span class="sr-only">Remove annotation</span></button></div>';return __p}},545:function(module,exports,__webpack_require__){var _=__webpack_require__(0);module.exports=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="lrn-imageupload-img-wrapper',hasImage||(__p+=" lrn-imageupload-img-wrapper-is-empty"),__p+='">',hasCanvasImage||(__p+='<img class="lrn-imageupload-img" alt="'+(null==(__t=alt)?"":_.escape(__t))+'" ',hasImage&&(__p+='src="'+(null==(__t=image)?"":_.escape(__t))+'"'),__p+=">"),__p+='</div><ul class="lrn-imageupload-annotations"></ul>';return __p}},546:function(module,exports,__webpack_require__){var _=__webpack_require__(0);module.exports=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="lrn-imageupload-config-upload-btn-container">',hasBrokenImage&&(__p+='<div class="lrn-imageupload-config-upload-wrapper"><p class="lrn-text-center">There was a problem loading your image. It may not have uploaded correctly.</p></div>'),__p+='<div class="lrn-imageupload-config-upload-wrapper"><span class="btn lrn_btn_blue lrn-imageupload-config-btn-upload">',hasBrokenImage?__p+=""+(null==(__t=labels.imageUpload.uploadNewImage)?"":__t):hasImage?__p+=""+(null==(__t=labels.imageUpload.replaceImage)?"":__t):__p+=""+(null==(__t=labels.imageUpload.uploadImage)?"":__t),__p+='</span><input class="lrn-imageupload-config-file-input" type="file" tabindex="0" '+(null==(__t=isInPreviewMode?'disabled="disabled"':"")?"":__t)+'></div><div class="alert alert-danger lrn-imageupload-config-error hidden"></div></div>',hasAnnotations&&!hasBrokenImage&&(__p+='<div><label><input class="lrn-imageupload-config-checkbox" type="checkbox">'+(null==(__t=labels.imageUpload.removeAllAnnotations)?"":__t)+"</label></div>"),__p+="",isInModal&&(__p+='<div class="lrn-imageupload-config-btn-container"><button class="lrn_btn" data-action="lrnResponseModalClose" type="button">'+(null==(__t=labels.cancel)?"":__t)+"</button>",hasImage&&!hasBrokenImage&&(__p+='<button class="lrn_btn_danger lrn-imageupload-config-btn-delete" type="button">'+(null==(__t=labels.delete)?"":__t)+"</button>"),__p+="</div>"),__p+="";return __p}},547:function(module,exports,__webpack_require__){var _=__webpack_require__(0);module.exports=function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="lrn-response-validate-wrapper" aria-label="'+(null==(__t=labels.ariaLabel.imageUpload.title)?"":_.escape(__t))+'">',shouldShowToolbar&&(__p+='<div class="lrn-imageupload-toolbar-outlet" aria-label="'+(null==(__t=labels.ariaLabel.imageUpload.toolbar)?"":_.escape(__t))+'"></div>'),__p+='<div class="lrn-imageupload-pinboard-outlet"></div><div class="lrn-imageupload-config-outlet"></div><div class="lrn-imageupload-no-content hidden"><p>No image or annotations</p></div></div><div class="lrn_correctAnswers lrn_hide"><span>'+(null==(__t=labels.correctAnswers)?"":__t)+':</span><ul class="lrn_correctAnswerList"></ul></div>',showValidationButton&&(__p+='<button type="button" class="lrn_btn lrn_validate"><span>'+(null==(__t=labels.checkAnswer)?"":_.escape(__t))+"</span></button>"),__p+="";return __p}},77:function(t,e,n){"use strict";n.r(e);var i=n(0),o=n.n(i),a=n(52),s=n(541),r=n.n(s),l=n(10),h=n(542),u=n.n(h),c=n(35);function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(t){return typeof t}:function _typeof(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(t){var e=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var n,i=_getPrototypeOf(t);if(e){var o=_getPrototypeOf(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return _possibleConstructorReturn(this,n)}}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var d=function ImageUploadScorer(t,e){if(!(this instanceof ImageUploadScorer))return new ImageUploadScorer(t,e);this.initialize(t,e)};d.prototype.initialize=function(t,e){var n=new p(t,e);this.correctResponses=function(){return n.correctResponses()},this.error=function(){return n.error()},this.isValid=function(){return n.isValid()},this.maxScore=function(){return n.maxScore()},this.score=function(){return n.score()},this.scoreWithFullPenalty=function(){return n.scoreWithFullPenalty()},this.validate=function(){return n.validate()},this.validateHotspots=function(){return n.validateHotspots()},this.questionResponse=function(){return n.questionResponse},this.canValidateResponse=function(){return n.canValidateResponse()},this.getFormattedQuestion=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return n.getFormattedQuestion.apply(n,e)},this.reset=function(t){return n.reset(t),this},this.initialize=void 0};var p=function(t){!function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}(InternalScorer,t);var e=_createSuper(InternalScorer);function InternalScorer(){return _classCallCheck(this,InternalScorer),e.apply(this,arguments)}return function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}(InternalScorer,[{key:"_initialize",value:function _initialize(t){t=this.processQuestionResponse(t),this.SHOULD_IGNORE_WHITESPACE=!0,this.scoringData={},this.question=t.question,this.response=t,this.hotspots=[],this.questionResponse=t,this.generateHotspots(),this.reset(t)}},{key:"comparisonIsCaseSensitive",value:function comparisonIsCaseSensitive(){return!!this.question.case_sensitive}},{key:"comparisonShouldIgnoreWhitespace",value:function comparisonShouldIgnoreWhitespace(){return this.SHOULD_IGNORE_WHITESPACE}},{key:"contentMatchesHotspot",value:function contentMatchesHotspot(t,e){return this.stringsMatch(t,e.correctAnswer)}},{key:"correctResponses",value:function correctResponses(){return this.scoringData.correctResponses}},{key:"error",value:function error(){return this.scoringData.error}},{key:"filterAnnotationsWithMatchingText",value:function filterAnnotationsWithMatchingText(){var t,e=this.getResponseAnnotations(),n=[];return e.length?(t=r.a.map(this.hotspots,(function(t){return t.correctAnswer})),r.a.each(e,r.a.bind((function(e){var i,o,a=e.content;for(o=0;o<t.length;o++)if(i=t[o],this.stringsMatch(a,i)){n.push(e);break}}),this)),n):n}},{key:"getAdjustedScore",value:function getAdjustedScore(t){var e,n,i=t.length,o=this.getResponseAnnotations().length,a=o-i,s=this.hotspots.length;return o<s&&(a=s-(o-a)),e={numCorrect:i,numIncorrect:a,numResponses:o,numResponseAreas:s,penalty:this.getPenalty()},n=this.isExactMatch()?this.getAdjustedScoreForExactMatch(e):this.isPartialMatchV2()?this.getAdjustedScoreForPartialMatchV2(e):this.getAdjustedScoreForPartialMatchPerResponse(e),this.shouldFloorScore()?Math.floor(n):n}},{key:"getAdjustedScoreForExactMatch",value:function getAdjustedScoreForExactMatch(t){var e=!!t.numIncorrect;return t.numCorrect!==t.numResponseAreas||e?0-t.penalty:this.maxScore()}},{key:"getAdjustedScoreForPartialMatchPerResponse",value:function getAdjustedScoreForPartialMatchPerResponse(t){return t.numCorrect*this.getScore()-t.numIncorrect*t.penalty}},{key:"getAdjustedScoreForPartialMatchV2",value:function getAdjustedScoreForPartialMatchV2(t){var e=this.maxScore(),n=t.numResponseAreas;return t.numCorrect*e/n-t.numIncorrect*t.penalty/n}},{key:"getPenalty",value:function getPenalty(){return this.question.validation.penalty||0}},{key:"getScoringType",value:function getScoringType(){return this.question.validation.scoring_type}},{key:"generateHotspots",value:function generateHotspots(){var t=this.getShapes(),e=this.getShapeAnswers();t.slice(0,e.length),r.a.each(t,r.a.bind((function(t,n){this.hotspots.push({coordinates:t,correctAnswer:e[n]})}),this))}},{key:"getAnnotationsMappedToHotspots",value:function getAnnotationsMappedToHotspots(t){var e=[],n=r.a.clone(t);return r.a.each(this.hotspots,(function(t,i){var o=t.coordinates,a={hotspot:t,annotations:[]};r.a.each(n,(function(t){var e={x:t.offset.left,y:t.offset.top};u.a.pointInPolygon(e,o)&&(t.hotspotIndex=i,a.annotations.push(t))})),a.annotations.length&&e.push(a)})),e}},{key:"getCorrectAnnotationsFromMapped",value:function getCorrectAnnotationsFromMapped(t){var e=[];return r.a.each(t,r.a.bind((function(t){var n,i,o=t.annotations,a=t.hotspot;for(i=0;i<o.length;i++)if(n=o[i].content,this.contentMatchesHotspot(n,a)){e.push(o[i]);break}}),this)),e}},{key:"getResponseAnnotations",value:function getResponseAnnotations(){var t=this.response;return r.a.getNested(t,"response.value.annotations")||[]}},{key:"getScore",value:function getScore(){var t=this.question;return r.a.getNested(t,"validation.valid_response.score")||0}},{key:"getShapeAnswers",value:function getShapeAnswers(){var t=this.question;return r.a.getNested(t,"validation.valid_response.value")||[]}},{key:"getShapes",value:function getShapes(){return this.question.imageValidationAreas||[]}},{key:"isScorable",value:function isScorable(){return!1!==r.a.getNested(this.question,"validation.automarkable")&&(this.hasShapes()&&this.hasShapeAnswers())}},{key:"hasResponseAnnotations",value:function hasResponseAnnotations(){return!!this.getResponseAnnotations().length}},{key:"hasShapeAnswers",value:function hasShapeAnswers(){return!!this.getShapeAnswers().length}},{key:"hasShapes",value:function hasShapes(){return!!this.getShapes().length}},{key:"isExactMatch",value:function isExactMatch(){return"exactMatch"===this.getScoringType()}},{key:"isPartialMatchV2",value:function isPartialMatchV2(){return"partialMatchV2"===this.getScoringType()}},{key:"isValid",value:function isValid(){return this.scoringData.isValid}},{key:"maxScore",value:function maxScore(){return this.scoringData.maxScore}},{key:"reset",value:function reset(t){var e=JSON.stringify(t);if(this.question=t.question,this.response=t,this.serializedData!==e){try{this.setScoringData(),l.a.normalizeScores(this.scoringData,this.response)}catch(t){this.scoringData={error:t}}this.serializedData=e}}},{key:"score",value:function score(){return this.isScorable()?l.a.generateScore({allowNegative:this.question.validation.allow_negative_scores,rawScore:this.scoringData.score,maxScore:this.maxScore()}):null}},{key:"scoreWithFullPenalty",value:function scoreWithFullPenalty(){return l.a.generateScore({allowNegative:!0,rawScore:this.scoringData.score,maxScore:this.maxScore()})}},{key:"setMaxScore",value:function setMaxScore(){var t=this.getScore();this.isExactMatch()||this.isPartialMatchV2()?this.scoringData.maxScore=t:this.scoringData.maxScore=this.hotspots.length*t}},{key:"setScoreAndCorrectResponses",value:function setScoreAndCorrectResponses(){var t,e,n=this.filterAnnotationsWithMatchingText();this.scoringData.correctResponses=[],n.length?(t=this.getAnnotationsMappedToHotspots(n)).length?(e=this.getCorrectAnnotationsFromMapped(t),this.scoringData.correctResponses=e,this.scoringData.score=this.getAdjustedScore(e)):this.scoringData.score=this.getAdjustedScore(t):this.scoringData.score=this.getAdjustedScore(n)}},{key:"setIsValid",value:function setIsValid(){var t,e;this.scoringData.score,this.scoringData.maxScore;if(!this.hasResponseAnnotations())return this.scoringData.isValid=null;e=this.scoringData.responsesValid,t=this.isExactMatch()?r.a.all(e)&&e.length===this.hotspots.length:r.a.any(e),this.scoringData.isValid=t}},{key:"setNonScorableData",value:function setNonScorableData(){this.scoringData={automarkable:!1,correctResponses:null,isValid:null,maxScore:null,responsesValid:null,score:null}}},{key:"setHotspotsValid",value:function setHotspotsValid(){var t=this.scoringData.correctResponses,e=r.a.map(this.hotspots,(function(e,n){return!!r.a.findWhere(t,{hotspotIndex:n})}));this.scoringData.hotspotsValid=e}},{key:"setResponsesValid",value:function setResponsesValid(){var t=this.scoringData.correctResponses,e=r.a.map(t,(function(t){return t.id})),n=this.getResponseAnnotations(),i=r.a.map(n,(function(t){return r.a.contains(e,t.id)}));this.scoringData.responsesValid=i}},{key:"canValidateResponse",value:function canValidateResponse(){return!(!this.scoringData||!this.scoringData.automarkable)}},{key:"setScoringData",value:function setScoringData(){this.isScorable()?(this.setMaxScore(),this.setScoreAndCorrectResponses(),this.setResponsesValid(),this.setHotspotsValid(),this.setIsValid()):this.setNonScorableData()}},{key:"shouldFloorScore",value:function shouldFloorScore(){return this.isPartialMatchV2()&&!("none"===this.question.validation.rounding)}},{key:"stringsMatch",value:function stringsMatch(t,e){var n=function stripWhitespace(t){return t.replace(/\s+/g,"")};return this.comparisonShouldIgnoreWhitespace()&&(t=n(t),e=n(e)),l.a.stringCompare(t,e,{caseSensitive:this.comparisonIsCaseSensitive()})}},{key:"validate",value:function validate(){return this.scoringData.responsesValid}},{key:"validateHotspots",value:function validateHotspots(){return this.scoringData.hotspotsValid}}]),InternalScorer}(c.a),g=d,f=n(14),m=n.n(f),v=a.a.extend({AUTHOR_DEFINED_IMAGE_REQUIRED_ATTRS:["source","width","height"],DEFAULT_ORIENTATION:0,ROTATION_DIRECTION:-90,getAnnotations:function getAnnotations(){if(this.hasAnnotations())return this.getResponseValue().annotations},getAspectRatio:function getAspectRatio(){var t,e;return this.hasAuthorDefinedImage()?(t=this.get("question").image).width/t.height:(e=this.getResponseValue())?e.aspectRatio:void 0},getAuthorDefinedImage:function getAuthorDefinedImage(){if(this.hasAuthorDefinedImage())return this.get("question").image},getImageOrientation:function getImageOrientation(){var t=this.getResponseValue();return this.hasResponse()&&o.a.isNumber(t.orientation)?t.orientation:this.DEFAULT_ORIENTATION},getScorerClass:function getScorerClass(){return g},hasAnnotations:function hasAnnotations(){var t=this.getResponseValue();return!!t&&!!t.annotations&&!!t.annotations.length},hasAuthorDefinedImage:function hasAuthorDefinedImage(){var t=!0,e=this.AUTHOR_DEFINED_IMAGE_REQUIRED_ATTRS,n=this.get("question").image;return!!n&&(o.a.each(e,(function(e){n[e]||(t=!1)})),t)},hasResponseImage:function hasResponseImage(){var t=this.getResponseValue();return!(!t||!t.image&&!t.asset)},hasImage:function hasImage(){return this.hasAuthorDefinedImage()||this.hasResponseImage()},hasValidationHotspots:function hasValidationHotspots(){var t=this.get("question").imageValidationAreas;return o.a.isArray(t)&&!!t.length},hasResponse:function hasResponse(){return a.a.prototype.hasResponse.call(this)&&!o.a.isEmpty(this.get("response").value)},instantFeedbackIsOn:function instantFeedbackIsOn(){return!!this.get("question").instant_feedback},isSubmitPractice:function isSubmitPractice(){return this.activity.get("type")===this.activity.TYPE.SUBMIT_PRACTICE},saveResponseImage:function saveResponseImage(t){var e=this.getResponseValue()||{};t.asset?(e.asset=t.asset,delete e.orientation):t.legacyBase64Image&&(e.image=t.legacyBase64Image),this.updateResponseValue(e)},clearResponse:function clearResponse(){var t=this.getResponseValue()||{};delete t.image,delete t.asset,delete t.orientation,o.a.isEmpty(t.annotations)&&delete t.aspectRatio,this.updateResponseValue(t)},processResponseValue:function processResponseValue(t){this.hasResponse()||this.set({response:{value:{},type:this.RESPONSE_TYPE.OBJECT}},{silent:!0}),delete this.get("response").uris,this.get("response").value=t},rotateImage:function rotateImage(){var t=this.getImageOrientation()+this.ROTATION_DIRECTION,e=this.getResponseValue();t===4*this.ROTATION_DIRECTION?e.orientation=0:e.orientation=t},validateHotspots:function validateHotspots(){return this.getScorer().validateHotspots()},validateResponse:function validateResponse(){return this.getScorer().validate()},getCorrectByIndex:function getCorrectByIndex(t){if(this.canValidateResponse()){var e=this.getValidResponse();return m.a.sanitizeHTML(e.value[t])}}}),b=n(1),y=n.n(b),A=n(5),w=n.n(A),I=n(53),S=n(51),E=S.a.isTouchDevice(),R=S.a.isTouchScalable();function addTouchEquivalentsForClickActions(){o.a.each(this.events,(function(t,e){var n;hasClickEvent(e)&&(n=e.replace(/^(click)/,"touchend"),this.events[n]=generateTouchAction.call(this,t))}),this)}function generateTouchAction(t){var e=o.a.isFunction(t)?t:this[t];return function(t){t.preventDefault(),e.apply(this,arguments)}}function hasClickEvent(t){return 0===t.indexOf("click")}var C=w.a.View.extend({delegateEvents:function delegateEvents(){var t=o.a.bind(w.a.View.prototype.delegateEvents,this);return!this.hasTouchEquivalentsForClickActions&&this.events&&E&&R&&function hasClickEvents(t){return!!o.a.filter(o.a.keys(t),hasClickEvent).length}(this.events)?(addTouchEquivalentsForClickActions.call(this),this.hasTouchEquivalentsForClickActions=!0,t()):t()}}),D=n(543),T=n.n(D),M=n(234),x=function isKeyOtherThanEnterOrSpace(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return o.a.exists(t.keyCode)&&!M.a.keyIs("enter",t)&&!M.a.keyIs("space",t)},V=C.extend({BUTTON_ACTIVE_CLASS:"lrn_active",BUTTON_DISABLED_CLASS:"lrn_disabled",UI_SELECTORS:{rotateBtn:".lrn-imageupload-btn-rotate",addAnnotationBtn:".lrn-imageupload-btn-add-annotation",configBtn:".lrn-imageupload-btn-config",deleteModeBtn:".lrn-imageupload-btn-delete"},className:"lrn_toolbar lrn-imageupload-toolbar",events:{"keydown .lrn_btn":function keydownLrn_btn(t){(M.a.keyIs("space",t)||M.a.keyIs("enter",t))&&t.preventDefault()},"click .lrn-imageupload-btn-rotate":"rotateImage","keydown .lrn-imageupload-btn-rotate":"rotateImage","click .lrn-imageupload-btn-delete":"toggleDeleteMode","keydown .lrn-imageupload-btn-delete":"toggleDeleteMode","click .lrn-imageupload-btn-add-annotation":"addAnnotation","keydown .lrn-imageupload-btn-add-annotation":"addAnnotation","click .lrn-imageupload-btn-config":"configureImage","keydown .lrn-imageupload-btn-config":"configureImage"},template:T.a,initialize:function initialize(t){this.options=t,this.hasAnnotations=this.options.hasAnnotations,this.hasResponseImage=this.options.hasResponseImage,this.isInDeleteMode=!1},addAnnotation:function addAnnotation(t){x(t)||this.canAddAnnotation()&&this.options.eventBus.trigger("addAnnotation",{addedViaKeyboard:M.a.keyIs("enter",t)||M.a.keyIs("space",t)},this)},cacheUI:function cacheUI(){return this.ui={},o.a.each(this.UI_SELECTORS,o.a.bind((function(t,e){this.ui["$"+e]=this.$(t)}),this)),this.buttons=o.a.filter([this.ui.$deleteModeBtn,this.ui.$addAnnotationBtn,this.ui.$configBtn,this.ui.$rotateBtn],(function(t){return!!t})),this},canAddAnnotation:function canAddAnnotation(){return!this.ui.$addAnnotationBtn.hasClass(this.BUTTON_DISABLED_CLASS)},canConfigureImage:function canConfigureImage(){return!this.ui.$configBtn.hasClass(this.BUTTON_DISABLED_CLASS)},canRotateImage:function canRotateImage(){return!this.ui.$rotateBtn.hasClass(this.BUTTON_DISABLED_CLASS)},canToggleDeleteMode:function canToggleDeleteMode(){return!this.ui.$deleteModeBtn.hasClass(this.BUTTON_DISABLED_CLASS)},configureImage:function configureImage(t){x(t)||this.canConfigureImage()&&this.options.eventBus.trigger("configureImage")},disable:function disable(t){var e=this,n=[];t&&o.a.isArray(t.except)&&n.concat(t.except),this.isInDeleteMode&&n.push(this.ui.$deleteModeBtn),this.buttons.forEach((function(t){if(o.a.contains(n,t))return e.enableButton(t);e.disableButton(t)}))},disableButton:function disableButton(t){t.addClass(this.BUTTON_DISABLED_CLASS),t.attr("aria-disabled",!0),t.attr("disabled",!0),t.attr("tabindex","-1")},disableRotateButton:function disableRotateButton(){this.disableButton(this.ui.$rotateBtn)},enable:function enable(t){var e=this,n=[];t&&o.a.isArray(t.except)&&n.concat(t.except),this.hasAnnotations||n.push(this.ui.$deleteModeBtn),this.hasResponseImage||n.push(this.ui.$rotateBtn),this.buttons.forEach((function(t){if(o.a.contains(n,t))return e.disableButton(t);e.enableButton(t)}))},enableDeleteModeButton:function enableDeleteModeButton(){this.enable()},enableButton:function enableButton(t){t.removeClass(this.BUTTON_DISABLED_CLASS),t.attr("aria-disabled",!1),t.removeAttr("disabled"),t.attr("tabindex","0")},enterDeleteAnnotationsMode:function enterDeleteAnnotationsMode(t){this.ui.$deleteModeBtn.addClass(this.BUTTON_ACTIVE_CLASS),this.isInDeleteMode=!0,this.disable(),this.options.eventBus.trigger("enterDeleteAnnotationsMode",{addedViaKeyboard:M.a.keyIs("enter",t)||M.a.keyIs("space",t)},this)},exitDeleteAnnotationsMode:function exitDeleteAnnotationsMode(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.ui.$deleteModeBtn.removeClass(this.BUTTON_ACTIVE_CLASS),this.isInDeleteMode=!1,this.enable(),t.silent||this.options.eventBus.trigger("exitDeleteAnnotationsMode",this)},focusAddAnnotationButton:function focusAddAnnotationButton(){this.ui.$addAnnotationBtn.focus()},focusConfigButton:function focusConfigButton(){this.ui.$configBtn.focus()},focusDeleteModeButton:function focusDeleteModeButton(){this.ui.$deleteModeBtn.focus()},render:function render(){var t=this.template({labels:this.options.labels,shouldEnableDeleteAnnotationsButton:this.hasAnnotations,shouldShowConfigButton:this.options.shouldShowConfigButton});return this.$el.append(t),this.cacheUI()},setDisabled:function setDisabled(t){this.hasAnnotations&&this.exitDeleteAnnotationsMode(),o.a.each(this.buttons,(function(e,n){var i=e.data("previously-disabled");return!t&&i?e.removeData("previously-disabled"):(i=e.hasClass("lrn_disabled"),t&&i?e.data("previously-disabled",!!i):void e.toggleClass("lrn_disabled",t).attr("aria-disabled",t))}))},rotateImage:function rotateImage(t){x(t)||this.canRotateImage()&&this.options.eventBus.trigger("rotateImage",this)},toggleDeleteMode:function toggleDeleteMode(t){x(t)||this.canToggleDeleteMode()&&(this.isInDeleteMode?this.exitDeleteAnnotationsMode():this.enterDeleteAnnotationsMode())}}),L=n(544),B=n.n(L),k="ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch||!1,O=function LrnDrag(t,e){var n=this,i={start_trigger:["mousedown","touchstart","MSPointerDown"],move_trigger:["mousemove","touchmove","MSPointerMove"],stop_trigger:["mouseup","touchend","touchcancel","MSPointerUp"],container:window.document.body,onStart:empty,onEnd:empty},o={};function dragStart(t){var e,i;k=!!t.targetTouches,n.isEnabled&&!function isDragException(t){var e=y()(t.target);return e.is("[data-lrn-drag-exception]")||!!e.closest("[data-lrn-drag-exception]").length}(t)&&function isValidMoveEvent(t){return!k||t.touches&&1===t.touches.length}(t)&&(n.options.outOfBoundDragEnabled&&!n.options.fixedContainer&&n.setContainer(n.options.container),blockEvent(t),this.dragStart=!0,e=getPagePosition(t),this.pagX=e.pageX,this.pagY=e.pageY,i=function getStylePosition(t){var e=t.style;return{x:parseInt(e.left||0,10),y:parseInt(e.top||0,10)}}(this),this.oriX=i.x,this.oriY=i.y,_forEach(n.options.move_trigger,(function(t){_addEventListener(document,t,n.move)})),_forEach(n.options.stop_trigger,(function(t){_addEventListener(document,t,n.end)})),callback("onStart"))}function dragMove(t){var e,n,i,a;!0===this.dragStart&&(blockEvent(t),e=this.style,n=getPagePosition(t),this.lastX=n.pageX,this.lastY=n.pageY,i=this.lastX-this.pagX,a=this.lastY-this.pagY,e.left=getInBetween(this.oriX+i,o.min_left,o.max_left)+"px",e.top=getInBetween(this.oriY+a,o.min_top,o.max_top)+"px")}function dragEnd(t){this.dragStart=!1,_forEach(n.options.move_trigger,(function(t){_removeEventListener(document,t,n.move)})),_forEach(n.options.stop_trigger,(function(t){_removeEventListener(document,t,n.end)})),callback("onEnd")}function _bind(t,e){var n=t;return function(t){n.call(e,t||window.event)}}function _removeEventListener(t,e,n){window.removeEventListener?t.removeEventListener(e,n):window.detachEvent&&t.detachEvent("on"+e,n)}function _addEventListener(t,e,n){window.addEventListener?t.addEventListener(e,n,!1):window.attachEvent&&t.attachEvent("on"+e,n)}function _forEach(t,e,n){for(var i=0,o=t.length;i<o;i++)e.call(n,t[i],i,t)}function empty(){}function callback(t){n.options[t]&&"function"==typeof n.options[t]&&n.options[t]()}function blockEvent(t){t.cancelBubble=!0,t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault()}function getInBetween(t,e,n){return t<e?e:t>n?n:t}function getPagePosition(t){var e,n,i=t||window.event;return k?(e=i.targetTouches[0].pageX,n=i.targetTouches[0].pageY):(e=i.pageX,n=i.pageY,void 0===e&&(e=i.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,n=i.clientY+document.body.scrollTop+document.documentElement.scrollTop)),{pageX:e,pageY:n}}function getDimensions(t){var e=t.style,n=e.visibility,i=e.display;e.visibility="hidden",e.display="block";var o=t.clientHeight,a=t.clientWidth;return e.display=i,e.visibility=n,{height:o,width:a}}this.disable=function(){this.isEnabled=!1},this.enable=function(){this.isEnabled=!0},this.setContainer=function(e){if(this.options.container=e,void 0!==e){var n=t.parentNode.getBoundingClientRect(),i=e.getBoundingClientRect(),a=i.width,s=i.height;if(e===window.document.body&&(a=document.width||document.body.clientWidth||document.documentElement.clientWidth,s=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight)),(o={el_rect:getDimensions(t),min_top:i.top-n.top,min_left:i.left-n.left}).max_top=s-o.el_rect.height+o.min_top,o.max_left=a-o.el_rect.width+o.min_left,this.options.outOfBoundDragEnabled){var r=100/(this.options.outOfBoundPercentage||50);o.max_top+=o.el_rect.height/r,this.options.outOfTopBoundDragDisabled||(o.min_top-=o.el_rect.height/r),o.min_left-=o.el_rect.width/r,o.max_left+=o.el_rect.width/r}}else o={}},function init(t,e){n.options=function _extend(){for(var t={},e=0,n=arguments.length;e<n;e++)for(var i in arguments[e])arguments[e].hasOwnProperty(i)&&(t[i]=arguments[e][i]);return t}(i,e),n.move=_bind(dragMove,t),n.end=_bind(dragEnd,t),n.isEnabled=!0,function bindEvents(t){var e=_bind(dragStart,t),i=n.options.dragHandleElement?n.options.dragHandleElement:t;_forEach(n.options.start_trigger,(function(t){_addEventListener(i,t,e)}))}(t),n.setContainer(n.options.container)}(t,e)},U=n(184),P=C.extend({BUBBLE_FADE_DURATION:200,NEAR_BOTTOM_CLASS:"lrn-imageupload-annotation-at-bottom-edge",NEAR_RIGHT_CLASS:"lrn-imageupload-annotation-at-right-edge",DEFAULT_OFFSET:{left:10,top:10},EXPANDED_CLASS:"lrn-imageupload-annotation-expanded",VALID_CLASS:"lrn_correct",INVALID_CLASS:"lrn_incorrect",PREVIEW_CHARACTER_LENGTH:15,UI_SELECTORS:{bubble:".lrn-imageupload-annotation-bubble",deleteBtn:".lrn-imageupload-annotation-btn-delete",dragHandle:".lrn-imageupload-annotation-drag-handle",preview:".lrn-imageupload-annotation-preview",textarea:"textarea"},STYLES:{focus:"lrn-focus"},className:"lrn-imageupload-annotation",events:{blur:"removeKeyboardEvents",focus:"onFocus","blur textarea":"contract","change textarea":"setContent","focus textarea":"onFocusTextArea","keydown textarea":"contractIfEnterKey","keyup textarea":"setContent","click .lrn-imageupload-annotation-preview":"expand","blur .lrn-imageupload-annotation-btn-delete":"onBlurDeleteButton","click .lrn-imageupload-annotation-btn-delete":"remove","focus .lrn-imageupload-annotation-btn-delete":"onFocusDeleteButton"},tagName:"li",template:B.a,initialize:function initialize(t){var e=t.initData.offset;this.options=t,this.content=t.initData.content||"",this.isInDeleteMode=!1,this.offset=o.a.extend({},this.DEFAULT_OFFSET,e),this.ui={},this.wasNearRight=!1,this.render()},addKeyboardEvents:function addKeyboardEvents(){var t=this,e=new M.a(this.$el),n=M.a.events;this.listenTo(e,n.enter,this.expand),this.listenTo(e,n.escape,this.onEscape),this.listenTo(e,n.arrowUp,(function(e){return t.move(e,"up")})),this.listenTo(e,n.arrowRight,(function(e){return t.move(e,"right")})),this.listenTo(e,n.arrowDown,(function(e){return t.move(e,"down")})),this.listenTo(e,n.arrowLeft,(function(e){return t.move(e,"left")})),this.listenTo(e,n.comboShiftArrowUp,(function(e){return t.move(e,"up",1)})),this.listenTo(e,n.comboShiftArrowRight,(function(e){return t.move(e,"right",1)})),this.listenTo(e,n.comboShiftArrowDown,(function(e){return t.move(e,"down",1)})),this.listenTo(e,n.comboShiftArrowLeft,(function(e){return t.move(e,"left",1)})),this.keyEmitter=e},addListenersForDisabled:function addListenersForDisabled(){var t=o.a.bind((function(t){y.a.contains(this.el,t)||this.contract()}),this);U.a.startListening(),this.listenTo(U.a,U.a.EVENTS.CLICK_OR_TAP,t)},afterAppend:function afterAppend(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.options.isInReviewMode?this.moveToOffset():this.makeDraggable(t),this.repositionBubble(),t.shouldFocus&&this.$el.focus()},animateBubbleHorizontalFlip:function animateBubbleHorizontalFlip(t){this.ui.$bubble.fadeOut({duration:this.BUBBLE_FADE_DURATION,complete:o.a.bind((function(){this.$el.toggleClass(this.NEAR_RIGHT_CLASS,t),this.ui.$bubble.fadeIn({duration:this.BUBBLE_FADE_DURATION,complete:o.a.bind((function(){this.ui.$deleteBtn.attr("style",!1)}),this)})}),this)})},blur:function blur(){document.activeElement===this.el?this.$el.blur():document.activeElement===this.ui.$textarea[0]&&this.ui.$textarea.blur()},cacheUI:function cacheUI(){o.a.each(this.UI_SELECTORS,o.a.bind((function(t,e){this.ui["$"+e]=this.$(t)}),this))},clearValidation:function clearValidation(){this.$el.removeClass(this.VALID_CLASS).removeClass(this.INVALID_CLASS)},contract:function contract(){this.ui.$preview.find("span").text(this.generatePreview()),this.$el.removeClass(this.EXPANDED_CLASS),this.options.isInReviewMode||this.isDisabled||this.lrnDrag.enable(),this.ui.$textarea.val(this.content),this.stopListening(U.a),this.removeKeyboardEvents()},contractIfEnterKey:function contractIfEnterKey(t){M.a.keyIs("enter",t)&&(t.preventDefault(),this.contract(),this.focus())},enterDeleteMode:function enterDeleteMode(){this.$el.attr("tabindex","-1"),this.isInDeleteMode=!0},exitDeleteMode:function exitDeleteMode(){this.$el.attr("tabindex","0"),this.isInDeleteMode=!1},expand:function expand(t){this.isInDeleteMode||this.isExpanded()||(this.$el.addClass(this.EXPANDED_CLASS),this.options.isInReviewMode||this.isDisabled?this.addListenersForDisabled():this.ui.$textarea.focus(),this.options.isInReviewMode||this.lrnDrag.disable(),this.options.eventBus.trigger("expandedAnnotation",this),t.preventDefault())},fenceToNewBoundaries:function fenceToNewBoundaries(){var t,e=this.$el.innerHeight(),n=this.getTopOffset()+e,i=this.getContainerHeight();n>i&&(t=i-e,this.$el.css({top:t+"px"}))},focus:function focus(){this.isInDeleteMode?this.focusDeleteButton():this.$el.focus()},focusDeleteButton:function focusDeleteButton(){this.isInDeleteMode&&this.ui.$deleteBtn.focus()},generateFencedPosition:function generateFencedPosition(t){var e=y()(this.options.boundingEl),n=o.a.clone(t);return n.x<0&&(n.x=0),n.y<0&&(n.y=0),n.x+this.$el.width()>e.innerWidth()&&(n.x=e.innerWidth()-this.$el.width()),n.y+this.$el.height()>e.innerHeight()&&(n.y=e.innerHeight()-this.$el.height()),n},generatePreview:function generatePreview(){var t=this.PREVIEW_CHARACTER_LENGTH,e=this.content.replace(/\s+/g," ").trim().substring(0,t);return e&&this.content.length>e.length&&(e+="..."),e||(this.options.isInReviewMode?this.options.labels.imageUpload.noResponse:this.options.labels.imageUpload.enterAnnotation)},getBubbleSpace:function getBubbleSpace(){var t=this.$el.offset().left,e=this.ui.$bubble.offset().left,n=t<e,i=this.ui.$bubble.innerWidth();return(n?e-t:t+this.$el.innerWidth()-(e+i))+i},getContainerHeight:function getContainerHeight(){return y()(this.options.boundingEl).innerHeight()},getContainerWidth:function getContainerWidth(){return y()(this.options.boundingEl).innerWidth()},getExpandedContentSpace:function getExpandedContentSpace(){var t=(this.ui.$bubble.innerHeight()-this.$el.innerHeight())/2;return this.ui.$textarea.innerHeight()-t},getId:function getId(){return this.options.initData.id},getLeftOffset:function getLeftOffset(){var t=y()(this.options.boundingEl).offset().left;return this.$el.offset().left-t},getTopOffset:function getTopOffset(){var t=y()(this.options.boundingEl).offset().top;return this.$el.offset().top-t},isExpanded:function isExpanded(){return this.$el.hasClass(this.EXPANDED_CLASS)},isNearBottom:function isNearBottom(){var t=this.getContainerHeight(),e=this.getExpandedContentSpace();return t<this.getTopOffset()+e},isNearRight:function isNearRight(){var t=this.getBubbleSpace();return this.getContainerWidth()<this.getLeftOffset()+t},leftOffsetToPx:function leftOffsetToPx(){var t=this.getContainerWidth()/100*this.offset.left,e=this.$el.innerWidth();return Math.round(t-e/2)+"px"},makeDraggable:function makeDraggable(t){return this.lrnDrag=new O(this.el,{onEnd:o.a.bind((function(){this.setOffset(),this.repositionBubble()}),this)}),this.setContainer(),this.moveToOffset(),t&&t.isNew&&this.setOffset(),this},moveToOffset:function moveToOffset(){this.$el.css({left:this.leftOffsetToPx(),top:this.topOffsetToPx()})},moveToRotateOffset:function moveToRotateOffset(t,e){this.$el.css({left:t,top:e})},move:function move(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;if(!this.isExpanded()){t.preventDefault();var i={x:this.getLeftOffset(),y:this.getTopOffset()},o={dx:0,dy:0};switch(e){case"up":o.dy=-1*n;break;case"right":o.dx=n;break;case"down":o.dy=n;break;case"left":o.dx=-1*n;break;default:throw new Error("Invalid annotation movement direction")}i.x+=o.dx,i.y+=o.dy,i=this.generateFencedPosition(i),this.$el.css({top:i.y,left:i.x}),this.setOffset(),this.repositionBubble()}},moveToPositionWithinNewContainerDimensions:function moveToPositionWithinNewContainerDimensions(){this.options.isInReviewMode||this.setContainer(),this.moveToOffset(),this.repositionBubble()},offsetHasChanged:function offsetHasChanged(t){var e=this.offset.top!==t.top,n=this.offset.left!==t.left;return e||n},onBlurDeleteButton:function onBlurDeleteButton(){this.$el.removeClass(this.STYLES.focus),this.removeKeyboardEvents()},onEscape:function onEscape(){this.isExpanded()?(this.contract(),this.$el.focus()):this.options.eventBus.trigger("keyboardEscapeAnnotation")},onFocus:function onFocus(){this.addKeyboardEvents()},onFocusDeleteButton:function onFocusDeleteButton(){this.$el.addClass(this.STYLES.focus),this.addKeyboardEvents()},onFocusTextArea:function onFocusTextArea(){this.addKeyboardEvents()},remove:function remove(t){var e=o.a.extend({silent:!1},t),n=this.options.eventBus;e.silent||n.trigger("deleteAnnotation",this),this.removeKeyboardEvents(),C.prototype.remove.call(this)},removeKeyboardEvents:function removeKeyboardEvents(){this.keyEmitter&&(this.stopListening(this.keyEmitter),this.keyEmitter.remove(),this.keyEmitter=null)},render:function render(){var t=!this.options.isInReviewMode&&!this.isDisabled,e=this.template({content:this.content,preview:this.generatePreview(),isDraggable:t,isEditable:t});return this.$el.html(e).attr("tabindex",t?"0":"-1"),this.cacheUI(),this},repositionBubble:function repositionBubble(){var t=this.isNearRight();this.wasNearRight!==t&&this.animateBubbleHorizontalFlip(t),this.$el.toggleClass(this.NEAR_BOTTOM_CLASS,this.isNearBottom()),this.wasNearRight=t},resetBoundaries:function resetBoundaries(){this.setContainer(),this.fenceToNewBoundaries(),this.setOffset(),this.repositionBubble()},rotate:function rotate(){var t=this.offset.leftOffsetRatio,e=this.offset.topOffsetRatio,n=this.getContainerWidth(),i=this.getContainerHeight(),o={top:i-i*t,left:n*e};this.offsetHasChanged(o)&&(this.offset=o,this.options.eventBus.trigger("changedAnnotation",this),this.moveToRotateOffset(this.offset.left,this.offset.top),this.resetBoundaries())},setContainer:function setContainer(){this.lrnDrag.setContainer(this.options.boundingEl)},setContent:function setContent(){this.content=m.a.sanitizeHTML(this.ui.$textarea.val()),this.options.eventBus.trigger("changedAnnotation",this)},setDisabled:function setDisabled(t){t?this.lrnDrag.disable():this.lrnDrag.enable(),this.isDisabled=t,this.render()},setOffset:function setOffset(){var t=y()(this.options.boundingEl),e=this.getLeftOffset(),n=this.getTopOffset(),i=t.width(),o=t.height(),a=e+this.$el.width()/2,s={top:(n+this.$el.height()/2)/o*100,left:a/i*100,leftOffsetRatio:e/i,topOffsetRatio:n/o};return this.offsetHasChanged(s)&&(this.offset=s,this.options.eventBus.trigger("changedAnnotation",this)),this},showValidity:function showValidity(t){this.$el.addClass(t?this.VALID_CLASS:this.INVALID_CLASS)},topOffsetToPx:function topOffsetToPx(){var t=this.getContainerHeight()/100*this.offset.top,e=this.$el.innerHeight();return Math.round(t-e/2)+"px"}}),$=C.extend({DELETE_MODE_CLASS:"lrn-imageupload-annotations-in-delete-mode",initialize:function initialize(t){this.options=t,this.annotationViews=[],this.addAnnotations()},addAnnotation:function addAnnotation(t,e){var n,i,a=o.a.extend({isNew:!0},e),s=this.options.eventBus;a.isNew&&(i=this.generateAnnotationId()),n=new P({eventBus:this.options.eventBus,boundingEl:this.el,labels:this.options.labels,initData:o.a.extend({id:i},t),isInReviewMode:this.options.isInReviewMode}),this.$el.append(n.$el),this.annotationViews.push(n),n.afterAppend(a),this.options.isInReviewMode||s.trigger("addedAnnotation",this),a.isNew&&this.publishChange()},addAnnotations:function addAnnotations(){o.a.each(this.options.annotations,o.a.bind((function(t){this.addAnnotation(t,{isNew:!1})}),this))},blur:function blur(){o.a.each(this.annotationViews,(function(t){t.blur()}))},clearValidation:function clearValidation(){o.a.each(this.annotationViews,(function(t){t.clearValidation()}))},deleteAllAnnotations:function deleteAllAnnotations(){o.a.each(this.annotationViews,(function(t){t.remove({silent:!0})})),this.annotationViews=[],this.publishChange()},deleteAnnotation:function deleteAnnotation(t){var e;for(e=0;e<this.annotationViews.length;e++)if(this.annotationViews[e]===t){this.annotationViews.splice(e,1);break}var n=this.annotationViews[e]||this.annotationViews[e-1];n&&n.focusDeleteButton(),this.publishChange()},enterDeleteMode:function enterDeleteMode(){this.$el.addClass(this.DELETE_MODE_CLASS),o.a.invoke(this.annotationViews,"enterDeleteMode")},exitDeleteMode:function exitDeleteMode(){this.$el.removeClass(this.DELETE_MODE_CLASS),o.a.invoke(this.annotationViews,"exitDeleteMode")},fitToNewDimensions:function fitToNewDimensions(){o.a.each(this.annotationViews,(function(t){t.moveToPositionWithinNewContainerDimensions()}))},focusFirst:function focusFirst(){var t=o.a.first(this.annotationViews);t&&t.focus()},generateAnnotationId:function generateAnnotationId(){for(var t=o.a.uniqueId(),e=o.a.map(this.annotationViews,(function(t){return t.getId()}));o.a.has(e,t);)t=o.a.uniqueId();return t},getData:function getData(){var t=[];return o.a.each(this.annotationViews,(function(e){t.push({id:e.getId(),content:e.content,offset:e.offset})})),t},publishChange:function publishChange(){this.options.eventBus.trigger("changedAnnotations",this)},remove:function remove(){o.a.each(this.annotationViews,(function(t){t.remove()})),C.prototype.remove.call(this)},resetBoundaries:function resetBoundaries(){o.a.each(this.annotationViews,(function(t){t.resetBoundaries()}))},rotate:function rotate(){o.a.invoke(this.annotationViews,"rotate")},setDisabled:function setDisabled(t){this.exitDeleteMode(),o.a.invoke(this.annotationViews,"setDisabled",t)},showValidity:function showValidity(t){o.a.each(t,o.a.bind((function(t,e){this.annotationViews[e].showValidity(t)}),this))}}),N=n(545),F=n.n(N),H=n(3);function dataURLToBlob(t){var e=t.match(/data:([^;]+)/)[1],n=t.replace(/^[^,]+,/,""),i=function binaryStringToArrayBuffer(t){var e=t.length,n=new ArrayBuffer(e),i=new Uint8Array(n),o=0;for(;o<e;)i[o]=t.charCodeAt(o),o++;return n}(atob(n));return new Blob([i],{type:e})}function blobToFile(t,e){var n;try{n=new File([t],e,{type:t.type})}catch(i){(n=t).name=e,n.lastModifiedDate=new Date}return n}var W={dataURLToBlob:dataURLToBlob,blobToFile:blobToFile,dataURLToFile:function dataURLToFile(t,e){return blobToFile(dataURLToBlob(t),e)}};function editableImage_typeof(t){return(editableImage_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(t){return typeof t}:function _typeof(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var j=function EditableImage(t){if(!(this instanceof EditableImage))return new EditableImage(t);this.cache={file:t,canvas:document.createElement("canvas")},this.cache.ctx=this.cache.canvas.getContext("2d")};function imageFromSource(t){return new H.default((function(e,n){var i=new Image,o=function removeListeners(){i.onload=null,i.onerror=null};i.onload=function(){o(),e(i)},i.onerror=function(){o(),n(Error(j.ERRORS.invalidSource))},i.src=t}))}j.ERRORS={invalidSource:"EditableImage source unavailable",fileReader:"EditableImage operation timed out"},o.a.extend(j,{ACCEPTABLE_FILE_TYPES:["jpeg","png","gif"],isCorrectFileType:function isCorrectFileType(t){var e=j.ACCEPTABLE_FILE_TYPES.join("|"),n=new RegExp("image/("+e+")$");return!!t&&"object"===editableImage_typeof(t)&&!!t.type&&!!t.type.match(n)}}),o.a.extend(j.prototype,{getCanvas:function getCanvas(){return this.cache.canvas},resize:function resize(t,e){var n=this,i=Math.round(t),a=Math.round(e);return o.a.extend(this.cache.canvas,{width:i,height:a}),new H.default((function(t,e){n.toImage().then((function(e){n.cache.ctx.drawImage(e,0,0,i,a),t(n)})).catch(e)}))},rotate:function rotate(t){var e=this;return this.toImage().then((function(n){var i=e.cache.canvas,o=e.cache.ctx,a=n.width,s=n.height,r=t*Math.PI/180,l=Math.round(1e3*Math.cos(r))/1e3,h=Math.round(1e3*Math.sin(r))/1e3;i.height=Math.abs(l*s)+Math.abs(h*a),i.width=Math.abs(l*a)+Math.abs(h*s),o.save(),-90===t&&o.translate(0,-h*a),-180!==t&&-270!==t||o.translate(i.width,-l*s),o.rotate(r),o.drawImage(n,0,0,a,s),o.restore()}))},scaleToMaxDimensions:function scaleToMaxDimensions(t,e){var n=this;return this.toImage().then((function(i){return i.width>i.height?n.scaleToWidth(t):n.scaleToHeight(e)}))},scaleToHeight:function scaleToHeight(t,e){var n=this;return this.toImage().then((function(e){var i=e.width,o=e.height,a=t/o*i;return n.resize(a,t)}))},scaleToWidth:function scaleToWidth(t,e){var n=this;return this.toImage().then((function(e){var i=e.width,o=e.height,a=t/i*o;return n.resize(t,a)}))},toDataURL:function toDataURL(t){var e=this;return new H.default((function(n,i){var a,s,r=e.cache.canvas;a=o.a.exists(t)&&o.a.isNumber(t.quality)?t.quality:1;try{s=r.toDataURL("image/jpeg",a)}catch(t){i(t)}s&&n(s)}))},toImage:function toImage(){var t=this;return this.cache.img?H.default.resolve(this.cache.img):new H.default((function(e,n){(function createImage(t){return new H.default((function(e,n){o.a.isString(t)?imageFromSource(t).then(e,n):function sourceFromFile(t){return new H.default((function(e,n){var i=new FileReader,o=function removeListeners(){i.onload=null,i.onerror=null};i.onload=function(t){o(),e(t.target.result)},i.onerror=function(){o(),n(Error(j.ERRORS.fileReader))},i.readAsDataURL(t)}))}(t).then((function(t){return imageFromSource(t)})).then(e,n)}))})(t.cache.file).then((function(n){t.cache.file=null,t.cache.img=n,e(n)})).catch(n)}))},compressJpeg:function compressJpeg(t){var e=this;return this.toDataURL(t).then((function(n){var i=e.getCanvas();return{file:W.dataURLToFile(n,t.fileName),dataURL:n,canvas:i}}))}});var q=j,z=C.extend({IMG_WRAPPER_EMPTY_CLASS:"lrn-imageupload-img-wrapper-is-empty",UI_SELECTORS:{annotations:".lrn-imageupload-annotations",canvas:".lrn-imageupload-img-wrapper canvas",img:".lrn-imageupload-img",imgWrapper:".lrn-imageupload-img-wrapper"},className:"lrn-imageupload-pinboard",template:F.a,initialize:function initialize(t){this.options=t,this.subViews={},this.templateData={},this.addRenderingLogic(),this.render()},addAnnotation:function addAnnotation(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.subViews.annotations.addAnnotation(null,t)},addRenderingLogic:function addRenderingLogic(){var t=this.options;this.templateData.hasImage=this.options.hasImage&&!this.options.hasBrokenImage,this.templateData.hasCanvasImage=!!this.options.canvasImage,this.options.authorImage?this.templateData.alt=this.options.authorImage.alt:this.templateData.alt="",this.options.hasImage&&(this.templateData.image=t.responseImage||t.authorImage.source)},afterAppend:function afterAppend(){return this.options.hasImage&&this.setHeight(),this.renderSubViews(),this},blurAnnotations:function blurAnnotations(){this.subViews.annotations.blur()},clearValidation:function clearValidation(){this.subViews.annotations.clearValidation()},contractOtherAnnotations:function contractOtherAnnotations(t){this.subViews.annotations.contractOtherAnnotations(t)},deleteAllAnnotations:function deleteAllAnnotations(){this.subViews.annotations.deleteAllAnnotations()},deleteAnnotation:function deleteAnnotation(t){this.subViews.annotations.deleteAnnotation(t)},disable:function disable(){this.setDisabled(!0)},enable:function enable(){this.setDisabled(!1)},enterDeleteAnnotationsMode:function enterDeleteAnnotationsMode(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.subViews.annotations.blur(),this.subViews.annotations.enterDeleteMode(),t.shouldFocusFirstAnnotation&&this.subViews.annotations.focusFirst()},exitDeleteAnnotationsMode:function exitDeleteAnnotationsMode(){this.subViews.annotations.exitDeleteMode()},fitToNewDimensions:function fitToNewDimensions(){this.setHeight(),this.subViews.annotations.fitToNewDimensions()},getAnnotationsData:function getAnnotationsData(){return this.subViews.annotations.getData()},getHeight:function getHeight(){var t=this.$el.innerWidth();return Math.round(t/this.options.aspectRatio)+"px"},hideImage:function hideImage(){var t=this.$(this.UI_SELECTORS.img),e=this.$(this.UI_SELECTORS.canvas),n=this.$(this.UI_SELECTORS.imgWrapper);t.add(e).remove(),n.addClass(this.IMG_WRAPPER_EMPTY_CLASS)},onceNewImageIsShown:function onceNewImageIsShown(){this.unsetHeight(),this.setAspectRatio(),this.setHeight()},remove:function remove(){o.a.each(this.subViews,(function(t){t.remove()})),C.prototype.remove.call(this)},render:function render(){var t,e=this.template(this.templateData);return this.$el.html(e),this.options.hasImage?(this.options.canvasImage&&this.$(this.UI_SELECTORS.imgWrapper).append(this.options.canvasImage),this.options.aspectRatio||(t=function(){this.setAspectRatio(),this.setHeight()}.bind(this),this.options.canvasImage?t():this.$(this.UI_SELECTORS.img).one("load",t)),this):this},renderSubViews:function renderSubViews(){this.options.aspectRatio&&this.setHeight(),this.subViews.annotations=new $({el:this.$(this.UI_SELECTORS.annotations),eventBus:this.options.eventBus,annotations:this.options.annotations,labels:this.options.labels,isInReviewMode:this.options.isInReviewMode})},rotateImage:function rotateImage(t){var e=this,n=new q(this.options.responseImage);this.options.orientation=t,n.rotate(t).then((function(){e.showNewImage({canvas:n.getCanvas()}),e.subViews.annotations.rotate()}))},setAspectRatio:function setAspectRatio(){var t,e,n,i,o=this.options.eventBus;this.options.canvasImage?(t=this.$(this.UI_SELECTORS.canvas),n=Number(t.attr("width")),i=Number(t.attr("height"))):(n=(t=this.$(this.UI_SELECTORS.img)).innerWidth(),i=t.innerHeight()),e=n/i,this.options.aspectRatio=e,o.trigger("changedAspectRatio",e,this)},setDisabled:function setDisabled(t){this.subViews.annotations.setDisabled(t)},setHeight:function setHeight(){this.$(this.UI_SELECTORS.imgWrapper).add(this.$(this.UI_SELECTORS.img)).css({height:this.getHeight()})},showNewImage:function showNewImage(t){t&&(t.canvas?this.showNewCanvasImage(t.canvas):this.showNewRegularImage(t.src),t.src&&(this.options.responseImage=t.src))},showNewCanvasImage:function showNewCanvasImage(t){var e=this.$(this.UI_SELECTORS.img),n=this.$(this.UI_SELECTORS.canvas),i=this.$(this.UI_SELECTORS.imgWrapper);this.options.canvasImage=t,e.add(n).remove(),i.append(t),this.onceNewImageIsShown()},showNewRegularImage:function showNewRegularImage(t){var e=this.$(this.UI_SELECTORS.img),n=this.$(this.UI_SELECTORS.imgWrapper),i=this.$(this.UI_SELECTORS.canvas);e.length||(e=y()("<img/>"),n.append(e)),i.remove(),n.removeClass(this.IMG_WRAPPER_EMPTY_CLASS),e.attr("src",t),e.one("load",this.onceNewImageIsShown.bind(this)),this.options.canvasImage=void 0},showValidAnnotations:function showValidAnnotations(t){this.subViews.annotations.showValidity(t)},unsetHeight:function unsetHeight(){this.$(this.UI_SELECTORS.imgWrapper).add(this.$(this.UI_SELECTORS.img)).add(this.$(this.UI_SELECTORS.canvas)).attr("style",!1)}},{create:function create(t){return new H.default((function(e,n){var i=!t.canvasImage&&t.hasImage&&!t.authorImage;if(!t.hasBrokenImage&&i){var o=new q(t.responseImage);o.rotate(t.orientation).then((function(){t.canvasImage=o.getCanvas(),e(new z(t))}),n)}else e(new z(t))}))}}),K=z,Y=n(546),X=n.n(Y),G=C.extend({FILE_TYPE_ERROR:"You can only add the following file types: ",GENERIC_ERROR:"Image couldn't be added, please try another image.",IMAGE_SCALE_MAX_HEIGHT:1200,IMAGE_SCALE_MAX_WIDTH:1200,IMAGE_QUALITY:.3,UI_SELECTORS:{annotationDeleteToggle:".lrn-imageupload-config-checkbox",error:".lrn-imageupload-config-error",fileInput:".lrn-imageupload-config-file-input",uploadBtn:".lrn-imageupload-config-btn-upload"},STYLES:{inputFocus:"lrn-focus"},className:"lrn-imageupload-config",events:{"click .lrn-imageupload-config-btn-delete":"deleteImage","change .lrn-imageupload-config-checkbox":"toggleAnnotationDelete","keypress .lrn-imageupload-config-checkbox":"toggleAnnotationDelete","change .lrn-imageupload-config-file-input":"onFileInputChange","focus .lrn-imageupload-config-file-input":"onFileInputFocus","blur .lrn-imageupload-config-file-input":"onFileInputBlur"},template:X.a,initialize:function initialize(t){this.options=t,this.ui={},this.shouldDeleteAnnotations=!1},cacheUI:function cacheUI(){o.a.each(this.UI_SELECTORS,o.a.bind((function(t,e){this.ui["$"+e]=this.$(t)}),this))},enableUpload:function enableUpload(){this.ui.$uploadBtn.attr("disabled",!1),this.ui.$fileInput.prop("disabled",!1)},deleteImage:function deleteImage(){this.shouldDeleteAnnotations&&this.options.eventBus.trigger("deleteAllAnnotations",this),this.options.eventBus.trigger("deleteImage",this)},disableUpload:function disableUpload(){this.ui.$uploadBtn.attr("disabled",!0),this.ui.$fileInput.prop("disabled",!0)},focusUploadButton:function focusUploadButton(){this.ui.$fileInput.focus()},hideError:function hideError(){this.ui.$error.text("").addClass("hidden")},onCancel:function onCancel(){this.options.hasBrokenImage&&this.deleteImage()},onFileInputBlur:function onFileInputBlur(){this.ui.$uploadBtn.removeClass(this.STYLES.inputFocus)},onFileInputChange:function onFileInputChange(){var t=this.ui.$fileInput[0].files[0];if(this.hideError(),this.disableUpload(),!q.isCorrectFileType(t))return this.enableUpload(),this.showFileTypeError();this.resizeImage(t),this.shouldDeleteAnnotations&&this.options.eventBus.trigger("deleteAllAnnotations",this)},onFileInputFocus:function onFileInputFocus(){this.ui.$uploadBtn.addClass(this.STYLES.inputFocus)},remove:function remove(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=this.ui.$fileInput;t.wasDismissed&&this.onCancel(),e.off(),"onpropertychange"in e[0]&&(e[0].onpropertychange=null),C.prototype.remove.call(this)},render:function render(){var t=this.options,e=this.template({labels:t.labels,hasAnnotations:t.hasAnnotations,hasBrokenImage:t.hasBrokenImage,hasImage:t.hasImage,isInModal:t.isInModal,isInPreviewMode:t.isInPreviewMode});return this.$el.html(e),this.cacheUI(),this},resizeImage:function resizeImage(t){var e=this.options.eventBus,n=new q(t),i=o.a.bind((function(){this.enableUpload(),this.showError()}),this),a=this.IMAGE_SCALE_MAX_HEIGHT,s=this.IMAGE_SCALE_MAX_WIDTH;n.scaleToMaxDimensions(s,a).then(function(){return n.compressJpeg({quality:this.IMAGE_QUALITY,fileName:"compressed.jpeg"})}.bind(this),i).then(function(t){e.trigger("imageLoaded",t,this)}.bind(this),i)},setDisabled:function setDisabled(t){return t?this.disableUpload():this.enableUpload()},showError:function showError(t){var e=t||this.GENERIC_ERROR;this.ui.$error.text(e).removeClass("hidden")},showFileTypeError:function showFileTypeError(){var t=q.ACCEPTABLE_FILE_TYPES.join(", "),e=this.FILE_TYPE_ERROR+t+".";this.showError(e)},toggleAnnotationDelete:function toggleAnnotationDelete(t){if(M.a.keyIs("enter",t))this.ui.$annotationDeleteToggle.click();else{var e=y()(t.currentTarget).is(":checked");this.shouldDeleteAnnotations=e}}}),Q=n(413),J=n(44),Z=n(547),tt=n.n(Z),et=n(239),nt=n(240);function _slicedToArray(t,e){return function _arrayWithHoles(t){if(Array.isArray(t))return t}(t)||function _iterableToArrayLimit(t,e){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(t)))return;var n=[],i=!0,o=!1,a=void 0;try{for(var s,r=t[Symbol.iterator]();!(i=(s=r.next()).done)&&(n.push(s.value),!e||n.length!==e);i=!0);}catch(t){o=!0,a=t}finally{try{i||null==r.return||r.return()}finally{if(o)throw a}}return n}(t,e)||function _unsupportedIterableToArray(t,e){if(!t)return;if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(t,e)}(t,e)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}var it=I.a.extend({AUTO_RESIZE_WAIT:500,BASE64_PREFIX:"data:image/jpeg;base64,",CORRECT_RESPONSE_CLASS:"lrn_correct",INCORRECT_RESPONSE_CLASS:"lrn_incorrect",VALID_RESPONSE_CLASS:"lrn_valid",UI_SELECTORS:{configOutlet:".lrn-imageupload-config-outlet",noContent:".lrn-imageupload-no-content",pinboardOutlet:".lrn-imageupload-pinboard-outlet",toolbarOutlet:".lrn-imageupload-toolbar-outlet",validationWrapper:".lrn-response-validate-wrapper",imageWrapper:".lrn-imageupload-img-wrapper",imageValidAreasWrapper:".lrn-valid-areas-wrapper"},eventBusActions:{addAnnotation:"addAnnotation",configureImage:"renderConfigModal",deleteAllAnnotations:"deleteAllAnnotations",deleteAnnotation:"deleteAnnotation",deleteImage:"deleteImage",enterDeleteAnnotationsMode:"enterDeleteAnnotationsMode",exitDeleteAnnotationsMode:"exitDeleteAnnotationsMode",keyboardEscapeAnnotation:"shiftFocusToToolbar",rotateImage:"rotateImage",addedAnnotation:"afterAddingAnnotation",changedAnnotation:"saveAnnotations",changedAnnotations:"saveAnnotations",changedAspectRatio:"saveAspectRatio",deletedAllAnnotations:"afterDeletingAllAnnotations",expandedAnnotation:"afterExpandingAnnotation",rendered:"initialisationCompleted",resizedLayout:"afterResizingLayout",imageLoaded:"afterLoadingImage",fileUploaded:"fileUploaded",fileUploadFailed:"fileUploadFailed"},template:tt.a,initialize:function initialize(t){I.a.prototype.initialize.apply(this,arguments),this.options=t,this.activity=this.options.activity,this.displayLogic={},this.eventBus=o.a.extend({},w.a.Events),this.subViews={},this.i18n=this.activity.get("i18n"),this.imageUploader=new et.a({activity:this.activity,eventBus:this.eventBus,modelId:this.model.get("id"),responseId:this.model.get("response_id")}),this.cache={},this.saveAnnotations=o.a.debounce(this.saveAnnotations.bind(this),10),this.render(),this.startAutoResize(),this.addListeners(),this.hasBeenRemoved=!1},addAnnotation:function addAnnotation(t){var e={shouldFocus:t.addedViaKeyboard};return this.getSubView("pinboard").then((function(t){return t&&t.addAnnotation(e)}))},addListeners:function addListeners(){this.bindEventBusActions()},applyMaxWidth:function applyMaxWidth(){this.$(this.UI_SELECTORS.validationWrapper).css({maxWidth:this.displayLogic.maxWidth})},afterAddingAnnotation:function afterAddingAnnotation(){return this.getSubView("toolbar").then((function(t){t.hasAnnotations=!0,t.enableDeleteModeButton()}))},addRenderingLogic:function addRenderingLogic(){I.a.prototype.addRenderingLogic.call(this),o.a.extend(this.displayLogic,{labels:this.activity.get("i18n").labels,shouldShowToolbar:!this.isInReviewMode(),maxWidth:this.model.get("question").max_width,showValidationButton:this.shouldShowValidationButton()})},afterDeletingAllAnnotations:function afterDeletingAllAnnotations(){var t=this;return this.getSubView("toolbar").then((function(e){return e.hasAnnotations=!1,e.exitDeleteAnnotationsMode(),t.hasImage()?(e.focusAddAnnotationButton(),H.default.resolve()):(t.saveAspectRatio(),H.default.all([t.removeConfigModal(),t.removePinboard()]).then((function(){return t.renderConfig()})).then((function(t){return t.focusUploadButton()})))}))},afterExpandingAnnotation:function afterExpandingAnnotation(t){!this.isInReviewMode()&&this.showingValidationUI&&this.clearValidationUI()},afterResizingLayout:function afterResizingLayout(){var t=this;this.getAllSubViews().then((function(e){e.forEach((function(t){"function"==typeof t.fitToNewDimensions&&t.fitToNewDimensions()})),t.showingValidationUI&&(t.validAreasPolygons&&t.validAreasPolygons.remove(),t.showValidationUI())}))},afterLoadingImage:function afterLoadingImage(t){var e=this;return this.saveImage(t),this.getSubView("toolbar").then((function(t){return t.hasResponseImage=!0,t.enable(),e.getSubView("pinboard")})).then((function(n){n&&t?n.showNewImage({canvas:t.canvas,src:t.dataURL}):(e.removeConfig(),e.renderPinboard({canvasImage:t.canvas}).catch(e.handleError.bind(e)))}))},clearValidationUI:function clearValidationUI(){var t=this;return this.getSubView("pinboard").then((function(e){!t.isInReviewMode()&&t.showingValidationUI&&(t.$(t.UI_SELECTORS.validationWrapper).removeClass(t.CORRECT_RESPONSE_CLASS).removeClass(t.INCORRECT_RESPONSE_CLASS),e.clearValidation(),t.displayLogic.displayCorrectAnswer&&t.validAreasPolygons&&(t.validAreasPolygons.remove(),t.clearCorrectAnswers()),t.showingValidationUI=!1,I.a.prototype.clearValidationUI.call(t))}))},bindEventBusActions:function bindEventBusActions(){o.a.each(this.eventBusActions,o.a.bind((function(t,e){this.listenTo(this.eventBus,e,this[t])}),this))},deleteAllAnnotations:function deleteAllAnnotations(){return this.getSubView("pinboard").then((function(t){return t.deleteAllAnnotations()}))},deleteAnnotation:function deleteAnnotation(t){return this.getSubView("pinboard").then((function(e){return e.deleteAnnotation(t)}))},deleteImage:function deleteImage(){var t=this;return H.default.all([this.getSubView("pinboard"),this.getSubView("toolbar")]).then((function(e){var n=_slicedToArray(e,2),i=n[0],o=n[1];return t.saveImage(),o.hasResponseImage=!1,t.model.hasAnnotations()?(i.hideImage(),o.disableRotateButton(),H.default.resolve()):t.removeConfigModal().then((function(){return t.removePinboard()})).then((function(){return t.renderConfig()})).then((function(t){return t.focusUploadButton()}))}))},enterDeleteAnnotationsMode:function enterDeleteAnnotationsMode(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.getSubView("pinboard").then((function(e){return e.enterDeleteAnnotationsMode({shouldFocusFirstAnnotation:t.addedViaKeyboard})}))},exitDeleteAnnotationsMode:function exitDeleteAnnotationsMode(){return H.default.all([this.getSubView("pinboard"),this.getSubView("toolbar")]).then((function(t){var e=_slicedToArray(t,2),n=e[0],i=e[1];n.exitDeleteAnnotationsMode(),i.exitDeleteAnnotationsMode({silent:!0})}))},getAllSubViews:function getAllSubViews(){var t=this;return new H.default((function(e){t.renderSubViews().then((function(){return e(o.a.values(t.subViews))}))}))},hasImage:function hasImage(){return this.model.hasImage()||!!this.cache.dataURL},getResponseImage:function getResponseImage(){var t,e;return!(!this.model.hasResponseImage()&&!this.cache.dataURL)&&(t=this.model.getResponseValue(),this.cache.dataURL?this.cache.dataURL:t.asset?this.imageUploader.resume(t.asset).getViewUrl():t.image&&this.model.get("response").type===this.model.RESPONSE_TYPE.IMAGE?this.imageUploader.resume(t.image).getViewUrl():(e=nt.a.decode(t.image),this.BASE64_PREFIX+e))},getSubView:function getSubView(t){var e=this;return new H.default((function(n){e.renderSubViews().then((function(){return n(e.subViews[t])}))}))},getValidatedResponses:function getValidatedResponses(){var t=this.model.getValidResponse().value||[],e=this.model.validateHotspots();return o.a.map(t,(function(t,n){return!!o.a.isBoolean(e[n])&&e[n]}))},getValidPolygons:function getValidPolygons(t,e,n){var i,a=[],s=[];return o.a.each(t,(function(t,e){var n=this.getResponseIndexLabel(e);s.push({ariaLabel:this.i18n.labels.imageValidationArea,className:this.VALID_RESPONSE_CLASS,coordinates:t}),a.push({polygonIndex:e,text:n,ariaLabel:n,className:"lrn_responseIndex"})}),this),(i=new J.a({className:this.UI_SELECTORS.imageValidAreasWrapper.replace(".",""),width:e,height:n,polygons:s})).renderLabels(a),i},handleError:function handleError(t){if(t.message!==q.ERRORS.invalidSource)throw t;this.handleErrorBrokenImage()},handleErrorBrokenImage:function handleErrorBrokenImage(){var t=this;this.renderPinboard({hasBrokenImage:!0}).then((function(){t.isInReviewMode()||t.renderConfigModal({hasBrokenImage:!0})})).catch((function(e){if(e.message===q.ERRORS.invalidSource)throw e;t.handleError(e)}))},initialisationCompleted:function initialisationCompleted(){this.stopListening(this.eventBus,"rendered"),I.a.prototype.initialisationCompleted.call(this)},isInPreviewMode:function isInPreviewMode(){var t=this.options.activity;return t.get("state")===t.STATE.PREVIEW},isInReviewMode:function isInReviewMode(){var t=this.options.activity;return t.get("state")===t.STATE.REVIEW},observeResize:function observeResize(){var t=this.$el.innerWidth(),e=this.$el.innerHeight();(t!==this.previousWidth||e!==this.previousHeight)&&(this.eventBus.trigger("resizedLayout"),this.previousWidth=t,this.previousHeight=e)},remove:function remove(){var t=this;return this.getAllSubViews().then((function(e){o.a.invoke(e,"remove"),t.validAreasPolygons&&t.validAreasPolygons.remove(),I.a.prototype.remove.call(t),t.hasBeenRemoved=!0}))},removeConfig:function removeConfig(){var t=this;return this.getSubView("config").then((function(e){e&&(e.remove(),e=null,delete t.subViews.config)}))},removeConfigModal:function removeConfigModal(){var t=this;return H.default.all([this.getSubView("modal"),this.getSubView("pinboard"),this.getSubView("toolbar")]).then((function(e){var n=_slicedToArray(e,3),i=n[0],o=n[1],a=n[2];return o&&o.enable(),a&&a.enable(),i?t.removeConfig().then((function(){t.stopListening(i),i.remove(),i=null,delete t.subViews.modal})):H.default.resolve()}))},removePinboard:function removePinboard(){var t=this;return H.default.all([this.getSubView("pinboard"),this.getSubView("toolbar")]).then((function(e){var n=_slicedToArray(e,2),i=n[0],o=n[1];i&&(o.disable(),i.remove(),i=null,delete t.subViews.pinboard)}))},render:function render(){var t=this;return this.addRenderingLogic(),this.renderViewContent(this.template(this.displayLogic)),this.applyMaxWidth(),this.renderSubViews().then((function(){t.previousWidth=t.$el.innerWidth(),t.previousHeight=t.$el.innerHeight(),t.isInReviewMode()&&t.renderValidatableUI(),t.eventBus.trigger("rendered")})),this},renderConfig:function renderConfig(){var t=this.$(this.UI_SELECTORS.configOutlet);return this.subViews.config=new G({labels:this.i18n.labels,eventBus:this.eventBus,hasAnnotations:this.model.hasAnnotations(),hasImage:this.hasImage(),isInModal:!1,isInPreviewMode:this.isInPreviewMode()}),t.append(this.subViews.config.render().$el),H.default.resolve(this.subViews.config)},renderPinboard:function renderPinboard(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return K.create({annotations:this.model.getAnnotations(),aspectRatio:this.model.getAspectRatio(),authorImage:this.model.getAuthorDefinedImage(),canvasImage:e.canvasImage,eventBus:this.eventBus,hasBrokenImage:!!e.hasBrokenImage,hasImage:this.hasImage(),labels:this.i18n.labels,orientation:this.model.getImageOrientation(),isInReviewMode:this.isInReviewMode(),responseImage:this.getResponseImage()}).then((function(e){var n=t.$(t.UI_SELECTORS.pinboardOutlet);t.subViews.pinboard=e,n.append(e.render().$el),e.afterAppend()})).catch(this.handleError.bind(this))},renderToolbar:function renderToolbar(){var t=this.$(this.UI_SELECTORS.toolbarOutlet);this.subViews.toolbar=new V({labels:this.i18n.labels,eventBus:this.eventBus,shouldShowConfigButton:!this.model.hasAuthorDefinedImage(),hasAnnotations:this.model.hasAnnotations(),hasResponseImage:this.model.hasResponseImage()}),t.append(this.subViews.toolbar.render().$el),(this.model.hasAnnotations()||this.hasImage())&&this.subViews.toolbar.enable()},renderConfigModal:function renderConfigModal(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return H.default.all([this.getSubView("pinboard"),this.getSubView("toolbar")]).then((function(n){var i=_slicedToArray(n,2),o=i[0],a=i[1];t.subViews.config=new G({labels:t.i18n.labels,eventBus:t.eventBus,hasAnnotations:t.model.hasAnnotations(),hasImage:t.hasImage(),hasBrokenImage:!!e.hasBrokenImage,isInModal:!0}),t.subViews.modal=new Q.a({contentView:t.subViews.config}),t.$(t.UI_SELECTORS.validationWrapper).append(t.subViews.modal.render().$el),o&&o.blurAnnotations(),o&&o.disable(),a&&a.disable(),t.subViews.modal.show(),t.subViews.config.focusUploadButton(),t.listenToOnce(t.subViews.modal,"remove",(function(){t.removeConfigModal().then((function(){return t.getSubView("toolbar")})).then((function(t){return t.focusConfigButton()}))}))}))},renderInNoImageOrAnnotationsMode:function renderInNoImageOrAnnotationsMode(){this.isInReviewMode()?this.$(this.UI_SELECTORS.noContent).removeClass("hidden"):(this.subViews.toolbar.disable(),this.renderConfig())},renderSubViews:function renderSubViews(){var t=this;return this.hasRenderedSubViews?H.default.resolve():(this.subViewRenderPromise||(this.subViewRenderPromise=new H.default((function(e){var n=function onRender(){t.subViewRenderPromise=null,t.hasRenderedSubViews=!0,e()};t.isInReviewMode()||t.renderToolbar(),t.model.hasAnnotations()||t.hasImage()?t.renderPinboard().then((function(){t.isInPreviewMode()&&t.subViews.toolbar.disable(),n()})).catch(t.handleError.bind(t)):(t.renderInNoImageOrAnnotationsMode(),n())}))),this.subViewRenderPromise)},rotateImage:function rotateImage(){var t;return this.model.rotateImage(),t=this.model.getImageOrientation(),this.getSubView("pinboard").then((function(e){return e.rotateImage(t)}))},save:function save(t,e){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=this.model.getResponseValue()||{};i[t]=e,this.model.updateResponseValue(i,{setAsModified:n})},saveAnnotations:function saveAnnotations(){var t=this;return this.getSubView("pinboard").then((function(e){var n=t.model.hasAnnotations(),i=e.getAnnotationsData();t.clearValidationUI(),t.save("annotations",i),!i.length&&n&&t.eventBus.trigger("deletedAllAnnotations")}))},saveAspectRatio:function saveAspectRatio(t){var e=this.model.getResponseValue(),n=!1;e&&o.a.isEmpty(e.annotations)&&(n=!0),this.imageUploader.assets.length>1&&e&&o.a.isUndefined(e.orientation)&&(n=!1),this.save("aspectRatio",t,n)},saveImage:function saveImage(t){var e,n=this,i={};return t?(this.cache.dataURL=t.dataURL,this.model.isSubmitPractice()?this.cache.latestAsset=this.imageUploader.upload(t.file):(e=t.dataURL.replace(this.BASE64_PREFIX,""),i.legacyBase64Image=nt.a.encode(e),this.model.saveResponseImage(i))):(delete this.cache.dataURL,this.model.clearResponse()),H.default.all([this.removeConfig(),this.removeConfigModal()]).then((function(){return n.getSubView("toolbar")})).then((function(t){return t.focusAddAnnotationButton()}))},shiftFocusToToolbar:function shiftFocusToToolbar(){var t=this;return this.getSubView("toolbar").then((function(e){return e.isInDeleteMode?t.exitDeleteAnnotationsMode().then((function(){e.focusDeleteModeButton()})):(e.focusAddAnnotationButton(),H.default.resolve())}))},shouldShowValidationButton:function shouldShowValidationButton(){return!this.isInReviewMode()&&this.model.instantFeedbackIsOn()&&this.displayLogic.showValidationButton},showCorrectAnswer:function showCorrectAnswer(){this.showCorrectAnswerList()},showValidationUI:function showValidationUI(){var t,e=this,n=I.a.prototype.showValidationUI.call(this),i=this.model.get("question").imageValidationAreas||[];return this.getSubView("pinboard").then((function(a){o.a.isArray(n)&&n.length&&a.showValidAnnotations(n),e.displayLogic.displayCorrectAnswer&&i.length&&(t=e.$(e.UI_SELECTORS.imageWrapper),e.validAreasPolygons=e.getValidPolygons(i,t.width(),t.height()),t.after(e.validAreasPolygons.el))}))},startAutoResize:function startAutoResize(){var t=this.AUTO_RESIZE_WAIT;this.hasBeenRemoved||(this.observeResize(),window.setTimeout(o.a.bind(this.startAutoResize,this),t))},getCorrectResponseTextByIndex:function getCorrectResponseTextByIndex(t){var e=this.model.getCorrectByIndex(t);return e=o.a.isArray(e)&&e.length>0?e[0]:e},setDisabled:function setDisabled(t){this.getAllSubViews().then((function(e){return o.a.invoke(e,"setDisabled",t)})),this.setButtonsDisabled(t)},fileUploaded:function fileUploaded(){var t=this.cache.latestAsset,e={asset:t.get("assetPath")};t.get("status")===t.UPLOAD_STATUS.complete&&this.model.saveResponseImage(e)},fileUploadFailed:function fileUploadFailed(){this.renderConfigModal.bind(this)({hasBrokenImage:!0})}});e.default={Model:v,View:it}}}]);